<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Aplikasi Absensi SD</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2 { color: #2563eb; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: center; }
    select, input { padding: 4px; }
    button { margin: 5px; padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; }
    button.primary { background: #2563eb; color: white; }
    button.secondary { background: #e0e7ff; color: #2563eb; }
    button.danger { background: #ef4444; color: white; }
    #login, #adminPanel, #guruPanel, #grafikPanel { display: none; }
    canvas { max-width: 600px; margin: 20px auto; display: block; }
  </style>
</head>
<body>
  <h1>üìö Aplikasi Absensi SD</h1>

  <!-- Login -->
  <div id="login">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button class="primary" onclick="login()">Login</button>
  </div>

  <!-- Panel Admin -->
  <div id="adminPanel">
    <h2>Panel Admin</h2>
    <h3>Tambah Siswa Baru</h3>
    <input type="text" id="namaBaru" placeholder="Nama siswa">
    <select id="genderBaru">
      <option value="L">Laki-laki</option>
      <option value="P">Perempuan</option>
    </select>
    <select id="kelasBaru">
      <option value="Kelas 1">Kelas 1</option>
      <option value="Kelas 2">Kelas 2</option>
      <option value="Kelas 3">Kelas 3</option>
      <option value="Kelas 4">Kelas 4</option>
      <option value="Kelas 5">Kelas 5</option>
      <option value="Kelas 6">Kelas 6</option>
    </select>
    <button class="primary" onclick="tambahSiswa()">Tambah</button>

    <h3>Tambah Akun Guru</h3>
    <input type="text" id="guruUser" placeholder="Username Guru">
    <input type="password" id="guruPass" placeholder="Password Guru">
    <select id="guruKelas">
      <option value="Kelas 1">Kelas 1</option>
      <option value="Kelas 2">Kelas 2</option>
      <option value="Kelas 3">Kelas 3</option>
      <option value="Kelas 4">Kelas 4</option>
      <option value="Kelas 5">Kelas 5</option>
      <option value="Kelas 6">Kelas 6</option>
    </select>
    <button class="primary" onclick="tambahGuru()">Tambah Guru</button>

    <h3>Daftar Akun Guru</h3>
    <ul id="daftarGuru"></ul>

    <h3>Grafik Absensi</h3>
    <select id="kelasGrafik">
      <option value="Semua">Semua Kelas</option>
      <option value="Kelas 1">Kelas 1</option>
      <option value="Kelas 2">Kelas 2</option>
      <option value="Kelas 3">Kelas 3</option>
      <option value="Kelas 4">Kelas 4</option>
      <option value="Kelas 5">Kelas 5</option>
      <option value="Kelas 6">Kelas 6</option>
    </select>
    <button class="secondary" onclick="tampilkanGrafikAdmin()">Lihat Grafik</button>

    <br><br>
    <button class="secondary" onclick="logout()">Logout</button>
  </div>

  <!-- Panel Guru -->
  <div id="guruPanel">
    <h2>Absensi</h2>
    <div id="kelas-container"></div>
    <div>
      <button class="primary" onclick="simpanAbsensi()">üíæ Simpan Absensi</button>
      <button class="secondary" onclick="unduhCSV()">‚¨áÔ∏è Unduh CSV</button>
      <button class="secondary" onclick="window.print()">üñ®Ô∏è Cetak Laporan</button>
      <button class="secondary" onclick="tampilkanGrafikGuru()">üìä Lihat Grafik</button>
      <button class="secondary" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Panel Grafik -->
  <div id="grafikPanel">
    <h2>üìä Grafik Absensi</h2>
    <canvas id="pieChart"></canvas>
    <canvas id="barChart"></canvas>
    <button class="secondary" onclick="tutupGrafik()">Tutup Grafik</button>
  </div>

  <script>
    // Data awal
    let dataKelas = JSON.parse(localStorage.getItem("dataKelas")) || {
      "Kelas 1": [{nama: "Ani", gender: "P"}, {nama: "Budi", gender: "L"}],
      "Kelas 2": [{nama: "Cici", gender: "P"}, {nama: "Dedi", gender: "L"}],
      "Kelas 3": [{nama: "Eka", gender: "P"}, {nama: "Fajar", gender: "L"}],
      "Kelas 4": [{nama: "Gina", gender: "P"}, {nama: "Hadi", gender: "L"}],
      "Kelas 5": [],
      "Kelas 6": []
    };
    let akunGuru = JSON.parse(localStorage.getItem("akunGuru")) || [];
    let absensiLog = JSON.parse(localStorage.getItem("absensiLog")) || [];

    const statusOptions = ["Hadir", "Izin", "Sakit", "Alpha", "Terlambat"];
    let userRole = null;
    let userKelas = null;

    // Tampilkan tabel absensi
    function renderTabel(kelas) {
      const container = document.getElementById("kelas-container");
      container.innerHTML = "";
      if (!dataKelas[kelas]) return;
      let html = <h3>${kelas}</h3><table><tr><th>Nama</th><th>Gender</th><th>Status</th></tr>;
      dataKelas[kelas].forEach(s => {
        const key = ${kelas}-${s.nama};
        const saved = localStorage.getItem(key) || "Hadir";
        html += `
          <tr>
            <td>${s.nama}</td>
            <td>${s.gender}</td>
            <td>
              <select id="${key}">
                ${statusOptions.map(opt => <option value="${opt}" ${saved===opt?"selected":""}>${opt}</option>).join("")}
              </select>
            </td>
          </tr>`;
      });
      html += "</table>";
      container.innerHTML = html;
    }

    // Simpan absensi harian
    function simpanAbsensi() {
      if (!userKelas) return;
      const today = new Date();
      const tgl = today.toISOString().split("T")[0]; // YYYY-MM-DD

      dataKelas[userKelas].forEach(s => {
        const key = ${userKelas}-${s.nama};
        const val = document.getElementById(key).value;
        localStorage.setItem(key, val);

        // simpan log harian
        absensiLog.push({
          tanggal: tgl,
          kelas: userKelas,
          nama: s.nama,
          status: val
        });
      });

      localStorage.setItem("absensiLog", JSON.stringify(absensiLog));
      alert("‚úÖ Absensi tersimpan!");
    }

    // Unduh CSV
    function unduhCSV() {
      if (!userKelas) return;
      let csv = "Tanggal,Kelas,Nama,Status\n";
      absensiLog.filter(l => l.kelas === userKelas).forEach(l => {
        csv += ${l.tanggal},${l.kelas},${l.nama},${l.status}\n;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "absensi_" + userKelas + ".csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Tambah siswa
    function tambahSiswa() {
      const nama = document.getElementById("namaBaru").value.trim();
      const gender = document.getElementById("genderBaru").value;
      const kelas = document.getElementById("kelasBaru").value;
      if (!nama) { alert("Nama tidak boleh kosong!"); return; }
      dataKelas[kelas].push({nama, gender});
      localStorage.setItem("dataKelas", JSON.stringify(dataKelas));
      document.getElementById("namaBaru").value = "";
      alert("‚úÖ Siswa baru ditambahkan!");
    }

    // Tambah guru
    function tambahGuru() {
      const user = document.getElementById("guruUser").value.trim();
      const pass = document.getElementById("guruPass").value.trim();
      const kelas = document.getElementById("guruKelas").value;
      if (!user || !pass) { alert("Username & Password wajib diisi!"); return; }
      akunGuru.push({username: user, password: pass, kelas});
      localStorage.setItem("akunGuru", JSON.stringify(akunGuru));
      renderGuruList();
      alert("‚úÖ Akun guru ditambahkan!");
    }

    function hapusGuru(i) {
      akunGuru.splice(i, 1);
      localStorage.setItem("akunGuru", JSON.stringify(akunGuru));
      renderGuruList();
    }
    function resetPass(i) {
      akunGuru[i].password = "1234";
      localStorage.setItem("akunGuru", JSON.stringify(akunGuru));
      renderGuruList();
      alert("‚úÖ Password direset ke '1234'");
    }

    function renderGuruList() {
      const ul = document.getElementById("daftarGuru");
      ul.innerHTML = "";
      akunGuru.forEach((g,i) => {
        ul.innerHTML += `<li>${g.username} (${g.kelas}) 
          <button onclick="resetPass(${i})">Reset</button>
          <button class="danger" onclick="hapusGuru(${i})">Hapus</button></li>`;
      });
    }

    // Grafik
    let pieChart, barChart;
    function tampilkanGrafik(data, judul) {
      document.getElementById("adminPanel").style.display = "none";
      document.getElementById("guruPanel").style.display = "none";
      document.getElementById("grafikPanel").style.display = "block";

      const ctxPie = document.getElementById("pieChart");
      const ctxBar = document.getElementById("barChart");

      if (pieChart) pieChart.destroy();
      if (barChart) barChart.destroy();

      // Hitung status bulan ini
      const bulanIni = new Date().getMonth();
      let countStatus = {Hadir:0,Izin:0,Sakit:0,Alpha:0,Terlambat:0};
      data.filter(d => new Date(d.tanggal).getMonth() === bulanIni)
          .forEach(d => countStatus[d.status]++);

      pieChart = new Chart(ctxPie, {
        type: "pie",
        data: {
          labels: Object.keys(countStatus),
          datasets: [{ data: Object.values(countStatus),
            backgroundColor: ["#22c55e","#f59e0b","#3b82f6","#ef4444","#8b5cf6"] }]
        },
        options: { plugins: { title: { display: true, text: Rekap Bulan Ini (${judul}) } } }
      });

      // Hitung per bulan
      let perBulan = Array(12).fill(0);
      data.forEach(d => { perBulan[new Date(d.tanggal).getMonth()]++; });

      barChart = new Chart(ctxBar, {
        type: "bar",
        data: {
          labels: ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"],
          datasets: [{ label:"Jumlah Absensi", data: perBulan, backgroundColor:"#2563eb" }]
        },
        options: { plugins: { title: { display: true, text: Rekap Tahunan (${judul}) } } }
      });
    }

    function tampilkanGrafikGuru() {
      const data = absensiLog.filter(l => l.kelas === userKelas);
      tampilkanGrafik(data, userKelas);
    }
    function tampilkanGrafikAdmin() {
      const kelas = document.getElementById("kelasGrafik").value;
      let data = absensiLog;
      if (kelas !== "Semua") data = data.filter(l => l.kelas === kelas);
      tampilkanGrafik(data, kelas);
    }
    function tutupGrafik() {
      document.getElementById("grafikPanel").style.display = "none";
      if (userRole==="admin") document.getElementById("adminPanel").style.display = "block";
      else document.getElementById("guruPanel").style.display = "block";
    }

    // Login
    function login() {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      if (u==="admin" && p==="1234") {
        userRole="admin";
        document.getElementById("login").style.display="none";
        document.getElementById("adminPanel").style.display="block";
        renderGuruList();
      } else {
        const guru = akunGuru.find(g=>g.username===u && g.password===p);
        if (guru) {
          userRole="guru"; userKelas=guru.kelas;
          document.getElementById("login").style.display="none";
          document.getElementById("guruPanel").style.display="block";
          renderTabel(userKelas);
        } else alert("‚ùå Username/Password salah!");
      }
    }

    function logout() {
      userRole=null; userKelas=null;
      document.getElementById("login").style.display="block";
      document.getElementById("adminPanel").style.display="none";
      document.getElementById("guruPanel").style.display="none";
      document.getElementById("grafikPanel").style.display="none";
    }

    // tampilkan login
    document.getElementById("login").style.display="block";
  </script>
</body>
</html>